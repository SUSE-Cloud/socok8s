---

- name: Install system packages for registry setup
  package:
    name: "{{ suse_registry_setup_packages }}"
    state: present
  register: install_packages
  until: install_packages is success
  retries: 5
  delay: 2
  tags:
    - install

- name: Ensure docker is running on host
  service:
    name: docker
    state: started

- name: Check if local docker registry server is running
  shell: |
    docker ps | grep {{ local_registry_name }}
  register: registry_running_cmd_status
  failed_when: false
  tags:
    - run

- name: Start local docker registry if not running
  shell: |
    docker run -d -p {{ local_registry_port }}:{{ local_registry_port }} --name {{ local_registry_name }} \
      --restart always -v {{ suse_registry_certs_dir}}:/certs \
      -e REGISTRY_HTTP_TLS_CERTIFICATE={{ suse_registry_certs_dir}}/domain.crt \
      -e REGISTRY_HTTP_TLS_KEY={{ suse_registry_certs_dir }}/domain.key registry:2
  when:
    - registry_running_cmd_status.rc != 0

- name: Ensure local-registry DNS resolution is set in /etc/hosts
  blockinfile:
    path: /etc/hosts
    block: |
      {{ ansible_default_ipv4.address | ipaddr('address') }} {{ local_registry_name }}
